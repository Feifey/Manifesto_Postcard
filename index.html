<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manifesto Postcard Gallery</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <h1>📮 Manifesto Postcard Gallery</h1>
  <p>Upload your postcard and see others’ submissions!</p>

  <input type="file" id="fileInput" accept="image/*">
  <button id="uploadBtn">Upload</button>
  <p id="statusMsg" class="hidden"></p>

  <div id="gallery" class="gallery"></div>

  <script type="module">
    import { db } from './firebase-config.js';
    import { 
      collection, addDoc, getDocs, query, orderBy 
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const imgbbAPIKey = "dd3cea06fcdb20b8aa36b4ba7f6d5ea1"; 
    const uploadBtn = document.getElementById("uploadBtn");
    const galleryDiv = document.getElementById("gallery");
    const statusMsg = document.getElementById("statusMsg");

    // Upload image to imgbb + Firestore
    async function uploadImage() {
      const file = document.getElementById("fileInput").files[0];
      if (!file) return alert("Please select an image first!");

      statusMsg.textContent = "Uploading...";
      statusMsg.className = "status uploading";

      const formData = new FormData();
      formData.append("image", file);

      try {
        const res = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbAPIKey}`, {
          method: "POST",
          body: formData,
        });

        const data = await res.json();
        const imageUrl = data.data.url;

        // Save to Firestore
        const docRef = await addDoc(collection(db, "gallery"), {
          url: imageUrl,
          timestamp: Date.now(),
        });

        showImage(imageUrl, docRef.id, true);
        statusMsg.textContent = "✅ Uploaded successfully!";
        statusMsg.className = "status success";
        setTimeout(() => (statusMsg.textContent = ""), 2500);
      } catch (err) {
        console.error(err);
        statusMsg.textContent = "❌ Upload failed.";
        statusMsg.className = "status error";
      }
    }

    // Load gallery
    async function loadGallery() {
      const snapshot = await getDocs(query(collection(db, "gallery"), orderBy("timestamp", "desc")));
      snapshot.forEach((docSnap) => showImage(docSnap.data().url, docSnap.id));
    }

    // Display image
    function showImage(url, id, prepend = false) {
      const img = document.createElement("img");
      img.src = url;
      img.loading = "lazy";
      img.className = "clickable-image";
      img.addEventListener("click", () => openImageModal(url, id));

      if (prepend) galleryDiv.prepend(img);
      else galleryDiv.appendChild(img);
    }

    // Open modal (with zoom + comments)
    function openImageModal(url, docId) {
      const modal = document.createElement("div");
      modal.className = "modal";
      modal.innerHTML = `
        <div class="modal-content">
          <img src="${url}" alt="Postcard" class="zoomable"/>
          <div class="comment-section">
            <h3>Comments</h3>
            <div class="comments-list" id="comments-${docId}"></div>
            <textarea id="commentInput-${docId}" placeholder="Write a comment..."></textarea>
            <button class="send-comment" data-id="${docId}">Send</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // Zoom with scroll
      const img = modal.querySelector(".zoomable");
      let scale = 1;
      img.addEventListener("wheel", (e) => {
        e.preventDefault();
        scale += e.deltaY * -0.001;
        scale = Math.min(Math.max(1, scale), 3);
        img.style.transform = `scale(${scale})`;
      });

      // Close modal when clicking outside
      modal.addEventListener("click", (e) => {
        if (e.target === modal) modal.remove();
      });

      // Load existing comments
      loadComments(docId);

      // Handle new comment
      modal.querySelector(".send-comment").addEventListener("click", async (e) => {
        const commentInput = document.getElementById(`commentInput-${docId}`);
        const text = commentInput.value.trim();
        if (!text) return;

        await addDoc(collection(db, "gallery", docId, "comments"), {
          text,
          timestamp: Date.now(),
        });

        commentInput.value = "";
        loadComments(docId); // Refresh comments
      });
    }

    // Load comments
    async function loadComments(docId) {
      const commentsContainer = document.getElementById(`comments-${docId}`);
      commentsContainer.innerHTML = "";
      const commentsSnap = await getDocs(
        query(collection(db, "gallery", docId, "comments"), orderBy("timestamp", "asc"))
      );

      commentsSnap.forEach((doc) => {
        const p = document.createElement("p");
        p.textContent = doc.data().text;
        p.className = "comment";
        commentsContainer.appendChild(p);
      });
    }

    uploadBtn.addEventListener("click", uploadImage);
    loadGallery();
  </script>

  <footer>
    <p>
      Project by 
      <a href="https://readymag.website/u3553625258/5543554/" target="_blank" rel="noopener noreferrer">
        <strong>Feifey W.</strong>
      </a>
    </p>
  </footer>
</body>
</html>
